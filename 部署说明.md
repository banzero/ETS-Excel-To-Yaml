# XML批量修改工具 - 远程部署指南

## 部署方案选择

### 方案一：NAS部署（推荐）
如果你的NAS支持Docker（如群晖、威联通、Unraid等），推荐使用Docker部署。

### 方案二：软路由部署
如果你的软路由是OpenWrt或其他Linux系统，可以使用systemd服务部署。

## 方案一：NAS Docker部署

### 1. 准备文件
将以下文件上传到NAS的某个目录（如 `/volume1/docker/xml-processor/`）：
- `app.py`
- `process_core.py`
- `requirements.txt`
- `Dockerfile`
- `docker-compose.yml`
- `templates/index.html`

### 2. 修改配置
编辑 `docker-compose.yml`：
```yaml
environment:
  - FLASK_SECRET_KEY=your-very-secure-secret-key-here  # 修改为强密码
```

### 3. 启动服务
在NAS的终端或SSH中执行：
```bash
cd /volume1/docker/xml-processor
docker-compose up -d
```

### 4. 验证部署
访问 `http://你的NAS内网IP:5678` 测试是否正常。

## 方案二：软路由部署

### 1. 上传文件
将项目文件上传到软路由的 `/opt/xml-processor/` 目录：
```bash
mkdir -p /opt/xml-processor
# 上传所有项目文件到此目录
```

### 2. 安装依赖
```bash
cd /opt/xml-processor
pip3 install -r requirements.txt
```

### 3. 配置systemd服务
```bash
# 复制服务文件
cp xml-processor.service /etc/systemd/system/

# 修改服务文件中的密钥
nano /etc/systemd/system/xml-processor.service
# 将 FLASK_SECRET_KEY 改为强密码

# 重载systemd并启动服务
systemctl daemon-reload
systemctl enable xml-processor
systemctl start xml-processor

# 检查状态
systemctl status xml-processor
```

### 4. 验证部署
访问 `http://你的软路由IP:5678` 测试。

## Lucky反向代理配置

### 1. 登录Lucky管理界面
访问你的Lucky管理界面（通常是 `http://你的公网IP:16601`）

### 2. 添加反向代理规则
1. 进入"反向代理"页面
2. 点击"添加规则"
3. 配置如下：
   - **规则名称**: XML处理器
   - **域名**: 你的域名（如 `xml.yourdomain.com`）
   - **目标地址**: `http://你的内网IP:5678`
   - **启用**: 勾选
   - **HTTPS**: 如果配置了SSL证书则勾选

### 3. 域名解析
在你的域名服务商处添加A记录：
- 主机记录：`xml`（或你想要的子域名）
- 记录值：你的公网IP

### 4. SSL证书（可选但推荐）
如果使用HTTPS：
1. 在Lucky中配置SSL证书
2. 或使用Let's Encrypt自动申请

## 安全建议

### 1. 修改默认密钥
务必修改 `FLASK_SECRET_KEY` 为强密码：
```bash
# 生成随机密钥
python3 -c "import secrets; print(secrets.token_hex(32))"
```

### 2. 防火墙设置
确保只开放必要端口：
- 公网：80（HTTP）、443（HTTPS）
- 内网：5678（应用端口）

### 3. 访问控制（可选）
如需限制访问，可以在Lucky中添加：
- IP白名单
- 基础认证
- 访问频率限制

## 故障排除

### 1. 服务无法启动
```bash
# 查看日志
docker logs xml-processor  # Docker方式
journalctl -u xml-processor -f  # systemd方式
```

### 2. 无法访问
- 检查防火墙设置
- 确认端口5678是否被占用
- 检查Lucky反向代理配置

### 3. 文件上传失败
- 检查文件大小是否超过16MB限制
- 确认Excel文件格式正确（.xlsx）
- 确认XML文件格式正确

## 更新应用

### Docker方式
```bash
cd /volume1/docker/xml-processor
docker-compose down
docker-compose build --no-cache
docker-compose up -d
```

### systemd方式
```bash
systemctl stop xml-processor
# 更新文件
systemctl start xml-processor
```

## 监控和维护

### 1. 查看服务状态
```bash
# Docker
docker ps | grep xml-processor

# systemd
systemctl status xml-processor
```

### 2. 查看日志
```bash
# Docker
docker logs -f xml-processor

# systemd
journalctl -u xml-processor -f
```

### 3. 重启服务
```bash
# Docker
docker-compose restart

# systemd
systemctl restart xml-processor
```

完成以上配置后，你就可以通过 `https://你的域名` 远程访问XML批量修改工具了！
